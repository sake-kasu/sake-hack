name: Main Branch Pipeline

on:
  push:
    branches:
      - main
    tags-ignore:
      - "**"

env:
  GO_VERSION: "1.25.4"
  COVERAGE_THRESHOLD: "80"
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/app

jobs:
  # ===== BUILD & PUSH DOCKER IMAGE =====
  build-and-push-image:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,format=long
            type=raw,value=main
            type=raw,value=latest

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/app/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Image pushed successfully
        run: |
          echo "✅ イメージをContainer Registryにプッシュしました"
          echo "pushed tags:"
          echo "${{ steps.meta.outputs.tags }}"

  # ===== TEST JOBS =====
  test-unit:
    name: Unit Tests (Main)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run unit tests
        run: |
          make test-unit
          echo "✅ mainブランチの単体テストが成功しました"

  test-integration:
    name: Integration Tests & Coverage (Main)
    runs-on: ubuntu-latest
    continue-on-error: true
    services:
      postgres:
        image: postgis/postgis:17-3.5
        env:
          POSTGRES_DB: sake_hack_app_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    env:
      POSTGRES_HOST: localhost
      POSTGRES_PORT: 5432
      POSTGRES_DB: sake_hack_app_test
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      TESTCONTAINERS_HOST_OVERRIDE: localhost

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install gocover-cobertura
        run: go install github.com/boumenot/gocover-cobertura@latest

      - name: Run integration tests
        run: make test-integration

      - name: Generate coverage report
        run: |
          make cover
          go tool cover -func=coverage.out
          gocover-cobertura < coverage.out > coverage.xml

      - name: Check coverage threshold
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "mainブランチのカバレッジ: ${COVERAGE}%"

          if [ -n "$COVERAGE" ]; then
            COVERAGE_NUM=$(echo "$COVERAGE" | sed 's/%//')
            THRESHOLD=${{ env.COVERAGE_THRESHOLD }}

            if (( $(echo "$COVERAGE_NUM < $THRESHOLD" | bc -l) )); then
              echo "⚠️  カバレッジが ${THRESHOLD}% を下回っています (現在: ${COVERAGE}%)"
            else
              echo "✅ カバレッジ要件を満たしています (${COVERAGE}%)"
            fi
          fi

          echo "✅ mainブランチの統合テストとカバレッジ測定が成功しました"

      - name: Upload coverage reports
        uses: actions/upload-artifact@v5
        with:
          name: coverage-reports-main
          path: |
            coverage.html
            coverage.out
            coverage.xml
          retention-days: 7

      - name: Generate coverage summary
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          filename: coverage.xml
          badge: true
          format: markdown
          output: both

      - name: Add coverage comment to commit
        uses: marocchino/sticky-pull-request-comment@v2
        if: always()
        with:
          recreate: true
          path: code-coverage-results.md
